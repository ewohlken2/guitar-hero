{"version":3,"names":["_chords","require","_chordMatching","describe","it","expect","normalizePitchClass","toBe","FLAT_TO_SHARP","toEqual","Db","Eb","Fb","Gb","Ab","Bb","Cb","createPitches","notes","map","note","index","frequency","confidence","pitches","result","matchChordFromNotes","chords","Date","now","not","toBeNull","chord","primaryName","score","toBeLessThan","toBeGreaterThan","toBeCloseTo","timestamp"],"sources":["chordMatching.test.ts"],"sourcesContent":["import { chords } from '../../src/constants/chords';\nimport {\n  FLAT_TO_SHARP,\n  normalizePitchClass,\n  matchChordFromNotes,\n} from '../../src/utils/chordMatching';\nimport { DetectedPitch } from '../../src/types';\n\ndescribe('normalizePitchClass', () => {\n  it('converts flat notes to sharp equivalents', () => {\n    expect(normalizePitchClass('Db')).toBe('C#');\n    expect(normalizePitchClass('Eb')).toBe('D#');\n    expect(normalizePitchClass('Gb')).toBe('F#');\n    expect(normalizePitchClass('Ab')).toBe('G#');\n    expect(normalizePitchClass('Bb')).toBe('A#');\n  });\n\n  it('returns natural notes unchanged', () => {\n    expect(normalizePitchClass('C')).toBe('C');\n    expect(normalizePitchClass('D')).toBe('D');\n    expect(normalizePitchClass('E')).toBe('E');\n    expect(normalizePitchClass('F')).toBe('F');\n    expect(normalizePitchClass('G')).toBe('G');\n    expect(normalizePitchClass('A')).toBe('A');\n    expect(normalizePitchClass('B')).toBe('B');\n  });\n\n  it('returns sharp notes unchanged', () => {\n    expect(normalizePitchClass('C#')).toBe('C#');\n    expect(normalizePitchClass('D#')).toBe('D#');\n    expect(normalizePitchClass('F#')).toBe('F#');\n    expect(normalizePitchClass('G#')).toBe('G#');\n    expect(normalizePitchClass('A#')).toBe('A#');\n  });\n\n  it('handles lowercase input', () => {\n    expect(normalizePitchClass('db')).toBe('C#');\n    expect(normalizePitchClass('eb')).toBe('D#');\n    expect(normalizePitchClass('c')).toBe('C');\n  });\n});\n\ndescribe('FLAT_TO_SHARP', () => {\n  it('contains all flat to sharp mappings', () => {\n    expect(FLAT_TO_SHARP).toEqual({\n      Db: 'C#',\n      Eb: 'D#',\n      Fb: 'E',\n      Gb: 'F#',\n      Ab: 'G#',\n      Bb: 'A#',\n      Cb: 'B',\n    });\n  });\n});\n\ndescribe('matchChordFromNotes', () => {\n  const createPitches = (notes: string[]): DetectedPitch[] => {\n    return notes.map((note, index) => ({\n      note,\n      frequency: 440 + index * 100,\n      confidence: 0.9,\n    }));\n  };\n\n  it('matches exact chord notes to a chord', () => {\n    // C major: C, E, G\n    const pitches = createPitches(['C', 'E', 'G']);\n    const result = matchChordFromNotes(pitches, chords, Date.now());\n\n    expect(result).not.toBeNull();\n    expect(result?.chord.primaryName).toBe('C');\n    expect(result?.score).toBe(1); // Perfect match\n  });\n\n  it('returns null when no pitches detected', () => {\n    const result = matchChordFromNotes([], chords, Date.now());\n    expect(result).toBeNull();\n  });\n\n  it('returns null when notes do not match any chord well', () => {\n    // Notes that don't form any recognizable chord pattern\n    // Using only one note - won't reach 50% threshold for 3+ note chords\n    // and won't match power chords (which need 2 specific notes)\n    const pitches = createPitches(['C#']);\n    const result = matchChordFromNotes(pitches, chords, Date.now());\n\n    // Single note C# won't match 50% of any chord (even power chords need 2 notes)\n    expect(result).toBeNull();\n  });\n\n  it('handles flat notes by normalizing to sharps', () => {\n    // F minor contains Ab which should be normalized to G#\n    // Fm: F, Ab, C -> F, G#, C\n    const pitches = createPitches(['F', 'Ab', 'C']);\n    const result = matchChordFromNotes(pitches, chords, Date.now());\n\n    expect(result).not.toBeNull();\n    expect(result?.chord.primaryName).toBe('Fm');\n  });\n\n  it('calculates score based on note overlap', () => {\n    // D major: D, F#, A - but we only detect D and F#\n    const pitches = createPitches(['D', 'F#']);\n    const result = matchChordFromNotes(pitches, chords, Date.now());\n\n    // Should match D major with 2/3 notes = 0.67 score\n    expect(result).not.toBeNull();\n    // Score should be less than 1 since not all notes detected\n    expect(result!.score).toBeLessThan(1);\n    expect(result!.score).toBeGreaterThan(0);\n    // 2 out of 3 notes for D major\n    expect(result!.score).toBeCloseTo(2 / 3, 2);\n  });\n\n  it('includes timestamp in the result', () => {\n    const timestamp = 1234567890;\n    const pitches = createPitches(['C', 'E', 'G']);\n    const result = matchChordFromNotes(pitches, chords, timestamp);\n\n    expect(result?.timestamp).toBe(timestamp);\n  });\n\n  it('prefers chords with higher overlap scores', () => {\n    // G major: G, B, D\n    // Em: E, G, B\n    // If we detect G, B we should get one of these\n    const pitches = createPitches(['G', 'B', 'D']);\n    const result = matchChordFromNotes(pitches, chords, Date.now());\n\n    expect(result).not.toBeNull();\n    expect(result?.chord.primaryName).toBe('G');\n    expect(result?.score).toBe(1);\n  });\n\n  it('handles duplicate detected notes', () => {\n    // Multiple octaves of the same note\n    const pitches = createPitches(['C', 'E', 'G', 'C', 'E']);\n    const result = matchChordFromNotes(pitches, chords, Date.now());\n\n    expect(result).not.toBeNull();\n    expect(result?.chord.primaryName).toBe('C');\n  });\n\n  it('filters low confidence pitches', () => {\n    const pitches: DetectedPitch[] = [\n      { note: 'C', frequency: 261.63, confidence: 0.9 },\n      { note: 'E', frequency: 329.63, confidence: 0.9 },\n      { note: 'G', frequency: 392.0, confidence: 0.9 },\n      { note: 'X', frequency: 100, confidence: 0.1 }, // Low confidence, should be ignored\n    ];\n    const result = matchChordFromNotes(pitches, chords, Date.now());\n\n    expect(result).not.toBeNull();\n    expect(result?.chord.primaryName).toBe('C');\n  });\n\n  it('requires minimum confidence threshold', () => {\n    const pitches: DetectedPitch[] = [\n      { note: 'C', frequency: 261.63, confidence: 0.3 },\n      { note: 'E', frequency: 329.63, confidence: 0.3 },\n      { note: 'G', frequency: 392.0, confidence: 0.3 },\n    ];\n    const result = matchChordFromNotes(pitches, chords, Date.now(), 0.5);\n\n    // All pitches below threshold, should return null\n    expect(result).toBeNull();\n  });\n});\n"],"mappings":"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","ignoreList":[]}